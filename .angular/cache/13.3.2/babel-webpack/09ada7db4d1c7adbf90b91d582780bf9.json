{"ast":null,"code":"import { __decorate, __metadata } from \"tslib\";\nimport { Router, ActivatedRoute } from '@angular/router';\nimport { Actions, Effect, ofType } from '@ngrx/effects';\nimport { select, Store } from '@ngrx/store';\nimport { Observable, of, from } from 'rxjs';\nimport { map, switchMap, catchError, withLatestFrom, concatMap } from 'rxjs/operators';\nimport store from 'store';\nimport { NzNotificationService } from 'ng-zorro-antd/notification';\nimport * as Reducers from 'src/app/store/reducers';\nimport * as UserActions from './actions';\nimport { basicAuthService } from 'src/app/services/basic-auth';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@ngrx/effects\";\nimport * as i2 from \"src/app/services/basic-auth\";\nimport * as i3 from \"@angular/router\";\nimport * as i4 from \"@ngrx/store\";\nimport * as i5 from \"ng-zorro-antd/notification\";\nexport class UserEffects {\n  constructor(actions, basicAuthService, router, route, rxStore, notification) {\n    this.actions = actions;\n    this.basicAuthService = basicAuthService;\n    this.router = router;\n    this.route = route;\n    this.rxStore = rxStore;\n    this.notification = notification;\n    this.login = this.actions.pipe(ofType(UserActions.LOGIN), map(action => action.payload), concatMap(action => of(action).pipe(withLatestFrom(this.rxStore.pipe(select(Reducers.getSettings))))), switchMap(([payload, settings]) => {\n      // basic-auth login\n      if (settings.authProvider === 'basic-auth') {\n        return this.basicAuthService.login(payload.email, payload.password).pipe(map(response => {\n          // if the response is authorized\n          if (response && response.accessToken) {\n            store.set('accessToken', response.accessToken);\n            this.notification.success('Logged In', 'You have successfully logged in!');\n            return new UserActions.LoadCurrentAccount();\n          }\n\n          this.notification.warning('Auth Failed', response);\n          return new UserActions.LoginUnsuccessful();\n        }), catchError(error => {\n          console.log('LOGIN ERROR: ', error);\n          return from([{\n            type: UserActions.LOGIN_UNSUCCESSFUL\n          }]);\n        }));\n      }\n    }));\n    this.loadCurrentAccount = this.actions.pipe(ofType(UserActions.LOAD_CURRENT_ACCOUNT), map(action => true), concatMap(action => of(action).pipe(withLatestFrom(this.rxStore.pipe(select(Reducers.getSettings))))), switchMap(([action, settings]) => {\n      // basic-auth load current account\n      if (settings.authProvider === 'basic-auth') {\n        return this.basicAuthService.currentAccount().pipe(map(response => {\n          if (response && (response.email || response.username)) {\n            if (this.route.snapshot.queryParams.returnUrl) {\n              this.router.navigate([this.route.snapshot.queryParams.returnUrl]); // // redirect to returnUrl\n            } else if (this.router.url.includes('/auth')) {\n              this.router.navigate(['/']); // redirect to root route on auth pages\n            }\n\n            return new UserActions.LoadCurrentAccountSuccessful(response);\n          }\n\n          return new UserActions.LoadCurrentAccountUnsuccessful();\n        }), catchError(error => {\n          console.log('ACCOUNT LOAD ERROR: ', error);\n          return from([{\n            type: UserActions.LOGIN_UNSUCCESSFUL\n          }]);\n        }));\n      }\n\n      return of(new UserActions.EmptyAction());\n    }));\n    this.logout = this.actions.pipe(ofType(UserActions.LOGOUT), map(action => true), concatMap(action => of(action).pipe(withLatestFrom(this.rxStore.pipe(select(Reducers.getSettings))))), switchMap(([, settings]) => {\n      // basic-auth logout\n      if (settings.authProvider === 'basic-auth') {\n        return this.basicAuthService.logout().pipe(map(() => {\n          store.remove('accessToken');\n          this.router.navigate(['/auth/login']);\n          return new UserActions.FlushUser();\n        }));\n      }\n\n      return of(new UserActions.EmptyAction());\n    }));\n  }\n\n  ngrxOnInitEffects() {\n    return {\n      type: UserActions.LOAD_CURRENT_ACCOUNT\n    };\n  }\n\n}\n\nUserEffects.ɵfac = function UserEffects_Factory(t) {\n  return new (t || UserEffects)(i0.ɵɵinject(i1.Actions), i0.ɵɵinject(i2.basicAuthService), i0.ɵɵinject(i3.Router), i0.ɵɵinject(i3.ActivatedRoute), i0.ɵɵinject(i4.Store), i0.ɵɵinject(i5.NzNotificationService));\n};\n\nUserEffects.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: UserEffects,\n  factory: UserEffects.ɵfac\n});\n\n__decorate([Effect(), __metadata(\"design:type\", Observable)], UserEffects.prototype, \"login\", void 0);\n\n__decorate([Effect(), __metadata(\"design:type\", Observable)], UserEffects.prototype, \"loadCurrentAccount\", void 0);\n\n__decorate([Effect(), __metadata(\"design:type\", Observable)], UserEffects.prototype, \"logout\", void 0);","map":null,"metadata":{},"sourceType":"module"}